# StockAgent å‰ç«¯æ¶æ„å‡çº§è®¾è®¡

> æ—¥æœŸ: 2026-02-08
> çŠ¶æ€: å·²ç¡®è®¤

## èƒŒæ™¯

é¡¹ç›® MVP é˜¶æ®µä½¿ç”¨ Streamlit å¿«é€ŸéªŒè¯åŠŸèƒ½ï¼Œç°æ ¸å¿ƒåŠŸèƒ½å·²ç¨³å®šï¼ˆä¿¡å·ç”Ÿæˆã€ç­–ç•¥ç®¡ç†ã€å›æµ‹ç³»ç»Ÿï¼‰ï¼Œéœ€å‡çº§ä¸ºä¸“ä¸šé‡‘èç»ˆç«¯çº§åˆ«çš„å‰åç«¯æ¶æ„ã€‚

## å…³é”®å†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© |
|---|---|
| å‰ç«¯æ¡†æ¶ | Next.js 14 + TradingView Lightweight Charts |
| åç«¯æ¡†æ¶ | FastAPI + SQLAlchemy 2.0 |
| éƒ¨ç½²æ¨¡å¼ | çº¯æœ¬åœ°è¿è¡Œ |
| é¡µé¢å¸ƒå±€ | æ··åˆæ¨¡å¼ï¼ˆæ ‡ç­¾é¡µå¯¼èˆª + è¡Œæƒ…é¡µå¤šé¢æ¿ï¼‰ |
| K çº¿åŠŸèƒ½ | æ ¸å¿ƒæŒ‡æ ‡ï¼ˆMA/RSI/MACD/KDJ/å¸ƒæ—å¸¦/ADX + ä¿¡å·æ ‡è®° + å¤šå‘¨æœŸï¼‰ |
| æ•°æ®æ›´æ–° | æ‰‹åŠ¨åˆ·æ–° |
| è¿ç§»ç­–ç•¥ | å…¨éƒ¨é‡å†™ |
| æ•°æ®åº“ | SQLite + SQLAlchemy ORM |

---

## 1. ç›®å½•ç»“æ„

```
stockagent/
â”œâ”€â”€ api/                          # FastAPI åç«¯
â”‚   â”œâ”€â”€ main.py                   # åº”ç”¨å…¥å£ + CORS + è·¯ç”±æ³¨å†Œ
â”‚   â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†ï¼ˆæ•°æ®æº tokenã€è·¯å¾„ç­‰ï¼‰
â”‚   â”œâ”€â”€ models/                   # SQLAlchemy ORM æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ base.py               # Base, engine, SessionLocal
â”‚   â”‚   â”œâ”€â”€ stock.py              # Stock, DailyPrice
â”‚   â”‚   â”œâ”€â”€ strategy.py           # Strategy, Rule, ExitConfig
â”‚   â”‚   â”œâ”€â”€ signal.py             # TradingSignal
â”‚   â”‚   â””â”€â”€ backtest.py           # BacktestRun, BacktestTrade
â”‚   â”œâ”€â”€ routers/                  # API è·¯ç”±ï¼ˆæŒ‰é¢†åŸŸåˆ†ç»„ï¼‰
â”‚   â”‚   â”œâ”€â”€ stocks.py             # /api/stocks/*
â”‚   â”‚   â”œâ”€â”€ strategies.py         # /api/strategies/*
â”‚   â”‚   â”œâ”€â”€ signals.py            # /api/signals/*
â”‚   â”‚   â”œâ”€â”€ backtest.py           # /api/backtest/*
â”‚   â”‚   â””â”€â”€ market.py             # /api/market/* (è¡Œæƒ…æ•°æ®)
â”‚   â”œâ”€â”€ services/                 # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ data_collector.py     # AkShare/TuShare æ•°æ®é‡‡é›†
â”‚   â”‚   â”œâ”€â”€ indicator_engine.py   # æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
â”‚   â”‚   â”œâ”€â”€ signal_engine.py      # è§„åˆ™å¼•æ“ + ä¿¡å·ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ backtest_engine.py    # å›æµ‹å¼•æ“
â”‚   â”‚   â””â”€â”€ market_regime.py      # å¸‚åœºçŠ¶æ€æ£€æµ‹
â”‚   â””â”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ api_guard.py          # ç†”æ–­å™¨
â”‚       â””â”€â”€ network.py            # ç½‘ç»œå·¥å…·
â”œâ”€â”€ web/                          # Next.js å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app/                  # App Router é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx        # å…¨å±€å¸ƒå±€ï¼ˆé¡¶éƒ¨å¯¼èˆªæ ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          # é¦–é¡µï¼ˆä»ªè¡¨ç›˜æ¦‚è§ˆï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ market/           # è¡Œæƒ…é¡µï¼ˆå¤šé¢æ¿ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ signals/          # ä¿¡å·é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ backtest/         # å›æµ‹é¡µ
â”‚   â”‚   â”‚   â””â”€â”€ strategies/       # ç­–ç•¥ç®¡ç†é¡µ
â”‚   â”‚   â”œâ”€â”€ components/           # å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ charts/           # TradingView å›¾è¡¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ panels/           # é¢æ¿ç»„ä»¶ï¼ˆè‡ªé€‰è‚¡ã€ä¿¡å·ç­‰ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ ui/               # åŸºç¡€ UI ç»„ä»¶ (shadcn/ui)
â”‚   â”‚   â”œâ”€â”€ hooks/                # è‡ªå®šä¹‰ React Hooks
â”‚   â”‚   â”œâ”€â”€ lib/                  # API å®¢æˆ·ç«¯ã€å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ types/                # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ data/                         # SQLite æ•°æ®åº“ + ç¼“å­˜
â””â”€â”€ start.sh                      # ä¸€é”®å¯åŠ¨ï¼ˆåç«¯ + å‰ç«¯ï¼‰
```

---

## 2. åç«¯ API è®¾è®¡

### æ•°æ®æ¨¡å‹ï¼ˆSQLAlchemy ORMï¼‰

```python
# api/models/stock.py
class Stock(Base):
    code: str           # "000001"
    name: str           # "å¹³å®‰é“¶è¡Œ"
    market: str         # "SZ" / "SH"
    industry: str       # è¡Œä¸šåˆ†ç±»

class DailyPrice(Base):
    stock_code: str
    date: date
    open, high, low, close, volume: float
    # å¤åˆå”¯ä¸€ç´¢å¼•: (stock_code, date)

# api/models/strategy.py
class Strategy(Base):
    name: str
    description: str
    enabled: bool
    buy_conditions: JSON    # [{indicator, operator, value, params}]
    sell_conditions: JSON
    exit_config: JSON       # {stop_loss_pct, take_profit_pct, max_hold_days}
```

### REST API ç«¯ç‚¹

```
è¡Œæƒ…æ•°æ®
  GET  /api/market/kline/{code}?period=daily&start=&end=   â†’ Kçº¿+æˆäº¤é‡
  GET  /api/market/indicators/{code}?indicators=RSI,MACD&params=...  â†’ æŒ‡æ ‡æ•°æ®
  GET  /api/market/quote/{code}                             â†’ æœ€æ–°æŠ¥ä»·

è‚¡ç¥¨åˆ—è¡¨
  GET  /api/stocks?keyword=&market=&page=&size=             â†’ æœç´¢/åˆ†é¡µ
  GET  /api/stocks/watchlist                                â†’ è‡ªé€‰è‚¡åˆ—è¡¨
  POST /api/stocks/watchlist                                â†’ æ·»åŠ è‡ªé€‰
  DELETE /api/stocks/watchlist/{code}                       â†’ ç§»é™¤è‡ªé€‰

ç­–ç•¥ç®¡ç†
  GET    /api/strategies                                    â†’ ç­–ç•¥åˆ—è¡¨
  POST   /api/strategies                                    â†’ åˆ›å»ºç­–ç•¥
  PUT    /api/strategies/{id}                               â†’ æ›´æ–°ç­–ç•¥
  DELETE /api/strategies/{id}                               â†’ åˆ é™¤ç­–ç•¥

ä¿¡å·
  GET  /api/signals/today                                   â†’ ä»Šæ—¥ä¿¡å·
  GET  /api/signals/history?page=&size=                     â†’ å†å²ä¿¡å·
  POST /api/signals/generate                                â†’ è§¦å‘ä¿¡å·ç”Ÿæˆ

å›æµ‹
  POST /api/backtest/run                                    â†’ è¿è¡Œå›æµ‹
  GET  /api/backtest/runs?strategy_id=                      â†’ å›æµ‹å†å²
  GET  /api/backtest/runs/{id}                              â†’ å›æµ‹è¯¦æƒ…+äº¤æ˜“æ˜ç»†
```

### å…³é”®è®¾è®¡ç‚¹

- **æŒ‡æ ‡è®¡ç®—æ”¾åç«¯** â€” `/api/market/indicators/` è¿”å›è®¡ç®—å¥½çš„æŒ‡æ ‡æ•°æ®ï¼Œå‰ç«¯åªè´Ÿè´£ç»‘å®šåˆ°å›¾è¡¨
- **K çº¿ + ä¿¡å·å åŠ ** â€” `/api/market/kline/` å¯é™„å¸¦ `?signals=true`ï¼Œè¿”å›æ•°æ®ä¸­åµŒå…¥ä¹°å–ä¿¡å·æ ‡è®°ç‚¹
- **å›æµ‹è¿›åº¦** â€” `POST /api/backtest/run` ç”¨ SSE æµå¼è¿”å›è¿›åº¦
- **è‡ªé€‰è‚¡** â€” æ–°å¢ `watchlist` è¡¨ï¼Œè¡Œæƒ…é¡µå·¦ä¾§é¢æ¿å±•ç¤º

---

## 3. å‰ç«¯é¡µé¢è®¾è®¡

### å…¨å±€å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logo   [ä»ªè¡¨ç›˜] [è¡Œæƒ…] [ä¿¡å·] [å›æµ‹] [ç­–ç•¥ç®¡ç†]     â”‚  â† é¡¶éƒ¨å¯¼èˆªæ ï¼ˆæ·±è‰²ä¸»é¢˜ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  é¡µé¢å†…å®¹åŒº                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- æ·±è‰²ä¸»é¢˜ï¼ˆé‡‘èç»ˆç«¯é£æ ¼ï¼‰
- shadcn/ui ç»„ä»¶åº“ + Tailwind CSS

### è¡Œæƒ…é¡µï¼ˆå¤šé¢æ¿å¸ƒå±€ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          â”‚  000001 å¹³å®‰é“¶è¡Œ  æ—¥K  å‘¨K  æœˆK  ğŸ”„  â”‚          â”‚
â”‚  è‡ªé€‰è‚¡   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ä¿¡å·é¢æ¿ â”‚
â”‚  åˆ—è¡¨     â”‚                                    â”‚          â”‚
â”‚          â”‚         K çº¿ä¸»å›¾                     â”‚  ä¹°å…¥ä¿¡å· â”‚
â”‚ â–¸ å¹³å®‰é“¶è¡Œâ”‚         (MA å åŠ  + ä¿¡å·æ ‡è®°)         â”‚  â— RSIè¶…å–â”‚
â”‚   600519 â”‚                                    â”‚  â— MACDé‡‘å‰â”‚
â”‚   000858 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚
â”‚          â”‚         å‰¯å›¾æŒ‡æ ‡                     â”‚  ç­–ç•¥çŠ¶æ€ â”‚
â”‚  â”€â”€â”€â”€â”€â”€ â”‚         (RSI / MACD / KDJ åˆ‡æ¢)     â”‚  æŒä»“å»ºè®® â”‚
â”‚  æœç´¢æ·»åŠ  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚          â”‚
â”‚          â”‚         æˆäº¤é‡                      â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- ä¸‰æ å¯æ‹–æ‹½è°ƒæ•´ï¼ˆreact-resizable-panelsï¼‰
- å·¦ä¾§è‡ªé€‰è‚¡ç‚¹å‡»åˆ‡æ¢ï¼Œæœç´¢æ¡†æ¨¡ç³Šæœç´¢
- ä¸­é—´ TradingView Lightweight Chartsï¼šä¸»å›¾ + å‰¯å›¾ + æˆäº¤é‡
- å³ä¾§ä¿¡å·é¢æ¿ï¼šå½“å‰è‚¡ç¥¨æœ€æ–°ä¿¡å·å’Œè§¦å‘æ¡ä»¶

### å…¶ä»–é¡µé¢ï¼ˆæ ‡ç­¾é¡µå†…å…¨å±ï¼‰

- **ä»ªè¡¨ç›˜** â€” æ¦‚è§ˆå¡ç‰‡ + æœ€æ–°ä¿¡å·åˆ—è¡¨ + å¸‚åœºçƒ­åº¦
- **ä¿¡å·é¡µ** â€” è¡¨æ ¼ä¸ºä¸»ï¼ŒæŒ‰æ—¥æœŸ/ç­–ç•¥/æ–¹å‘ç­›é€‰ï¼Œç‚¹å‡»è·³è½¬è¡Œæƒ…é¡µ
- **å›æµ‹é¡µ** â€” å‚æ•°é¢æ¿ + ç»“æœå¡ç‰‡ + æƒç›Šæ›²çº¿ + äº¤æ˜“æ˜ç»†è¡¨
- **ç­–ç•¥ç®¡ç†** â€” ç­–ç•¥åˆ—è¡¨ + è§„åˆ™ç¼–è¾‘å™¨ï¼ˆæ¡ä»¶/åŠ¨ä½œ/å‚æ•°è¡¨å•åŒ–ï¼‰

---

## 4. æŠ€æœ¯æ ˆ

### å‰ç«¯

| ç”¨é€” | é€‰å‹ | ç†ç”± |
|---|---|---|
| æ¡†æ¶ | Next.js 14 (App Router) | æ–‡ä»¶è·¯ç”±ã€SSR/CSR çµæ´»åˆ‡æ¢ |
| UI ç»„ä»¶ | shadcn/ui + Tailwind CSS | ä¸“ä¸šå¤–è§‚ã€æ·±è‰²ä¸»é¢˜ã€é›¶è¿è¡Œæ—¶ |
| å›¾è¡¨ | lightweight-charts (TradingView) | é‡‘èçº§ K çº¿ã€è½»é‡é«˜æ€§èƒ½ |
| é¢æ¿å¸ƒå±€ | react-resizable-panels | æ‹–æ‹½åˆ†æ ã€æŒä¹…åŒ–å°ºå¯¸ |
| æ•°æ®è¯·æ±‚ | TanStack Query | ç¼“å­˜ã€é‡è¯•ã€loading çŠ¶æ€ |
| çŠ¶æ€ç®¡ç† | Zustand | è½»é‡å…¨å±€çŠ¶æ€ |
| è¡¨æ ¼ | TanStack Table | æ’åºã€ç­›é€‰ã€åˆ†é¡µ |
| ç±»å‹ | TypeScript | å‰åç«¯ç±»å‹ä¸€è‡´æ€§ |

### åç«¯

| ç”¨é€” | é€‰å‹ | ç†ç”± |
|---|---|---|
| æ¡†æ¶ | FastAPI | è‡ªåŠ¨ OpenAPIã€asyncã€ç±»å‹æ ¡éªŒ |
| ORM | SQLAlchemy 2.0 | å£°æ˜å¼æ¨¡å‹ã€å¯è¿ç§» |
| æ•°æ®æ ¡éªŒ | Pydantic v2 | ä¸ FastAPI åŸç”Ÿé›†æˆ |
| æ•°æ®åº“ | SQLite | é›¶é…ç½®ã€æ–‡ä»¶çº§å¤‡ä»½ |
| æ•°æ®é‡‡é›† | AkShare + TuShare | æ²¿ç”¨ç°æœ‰æ•°æ®æº |
| æŒ‡æ ‡è®¡ç®— | pandas | å°è£…ä¸º service |

### å¯åŠ¨æ–¹å¼

```bash
#!/bin/bash
# åç«¯
cd api && uvicorn main:app --reload --port 8000 &
# å‰ç«¯ï¼ˆproxy /api â†’ :8000ï¼‰
cd web && npm run dev &
open http://localhost:3000
```

---

## 5. å®æ–½é¡ºåº

1. **Phase 1: åç«¯éª¨æ¶** â€” FastAPI é¡¹ç›®åˆå§‹åŒ–ã€SQLAlchemy æ¨¡å‹ã€æ•°æ®åº“è¿ç§»ã€è¡Œæƒ… API
2. **Phase 2: å‰ç«¯éª¨æ¶** â€” Next.js é¡¹ç›®åˆå§‹åŒ–ã€å…¨å±€å¸ƒå±€ã€è·¯ç”±ã€æ·±è‰²ä¸»é¢˜
3. **Phase 3: è¡Œæƒ…é¡µ** â€” TradingView å›¾è¡¨ã€è‡ªé€‰è‚¡é¢æ¿ã€æŒ‡æ ‡å‰¯å›¾ã€ä¿¡å·æ ‡è®°
4. **Phase 4: ä¿¡å·ç³»ç»Ÿ** â€” ä¿¡å· API + å‰ç«¯ä¿¡å·é¡µ + ä»ªè¡¨ç›˜æ¦‚è§ˆ
5. **Phase 5: å›æµ‹ç³»ç»Ÿ** â€” å›æµ‹ API + å‰ç«¯å›æµ‹é¡µ + SSE è¿›åº¦
6. **Phase 6: ç­–ç•¥ç®¡ç†** â€” ç­–ç•¥ CRUD API + å‰ç«¯è§„åˆ™ç¼–è¾‘å™¨
