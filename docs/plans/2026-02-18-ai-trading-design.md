# AI æ¨¡æ‹Ÿäº¤æ˜“ç³»ç»Ÿè®¾è®¡

## æ¦‚è¿°

åœ¨ç°æœ‰ AI åˆ†ææŠ¥å‘Šç³»ç»ŸåŸºç¡€ä¸Šï¼Œå¢åŠ ã€Œæœºå™¨äººæ¨¡æ‹Ÿäº¤æ˜“ã€åŠŸèƒ½ã€‚æŠ¥å‘Šç”Ÿæˆåè‡ªåŠ¨æ‰§è¡Œä¹°å–æ“ä½œï¼ˆæ¨¡æ‹Ÿç›˜ï¼‰ï¼Œæ¯æ­¥è®°å½•è¯¦ç»†æ€è€ƒè¿‡ç¨‹ï¼Œæ¸…ä»“åè‡ªåŠ¨å¤ç›˜å¹¶å†™å…¥è®°å¿†åº“ã€‚

## æ ¸å¿ƒå†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| äº¤æ˜“æ¨¡å¼ | æ¨¡æ‹Ÿç›˜ï¼ˆçº¸ä¸Šäº¤æ˜“ï¼‰ | éªŒè¯ AI é€‰è‚¡å’Œæ—¶æœºèƒ½åŠ›ï¼Œæ— å®é™…èµ„é‡‘é£é™© |
| è§¦å‘æ—¶æœº | æŠ¥å‘Šä¿å­˜åè‡ªåŠ¨æ‰§è¡Œ | æ— éœ€äººå·¥å¹²é¢„ï¼Œå®Œå…¨è‡ªåŠ¨åŒ– |
| èµ„é‡‘æ¨¡å¼ | æ— é™èµ„é‡‘ | ä¸“æ³¨éªŒè¯é€‰è‚¡å’Œä¹°å–æ—¶æœºï¼Œä¸å—èµ„é‡‘çº¦æŸ |
| å•æ¬¡ä¹°å…¥ | Â¥100,000 | å›ºå®šé‡‘é¢ï¼Œæ–¹ä¾¿æ¨ªå‘å¯¹æ¯” |
| å¤ç›˜æ—¶æœº | å…¨éƒ¨å–å‡ºåè‡ªåŠ¨è§¦å‘ | ç‹¬ç«‹ Claude è°ƒç”¨ï¼Œæ·±åº¦åˆ†æå®Œæ•´äº¤æ˜“å‘¨æœŸ |

## æ•°æ®æ¨¡å‹

### bot_portfolioï¼ˆæœºå™¨äººæŒä»“ï¼‰

```python
class BotPortfolio(Base):
    __tablename__ = "bot_portfolio"
    id: int (PK)
    stock_code: str (unique, indexed)  # è‚¡ç¥¨ä»£ç 
    stock_name: str                     # è‚¡ç¥¨åç§°
    quantity: int                       # æŒä»“æ•°é‡
    avg_cost: float                     # å¹³å‡æˆæœ¬
    total_invested: float               # ç´¯è®¡æŠ•å…¥é‡‘é¢
    first_buy_date: str                 # é¦–æ¬¡ä¹°å…¥æ—¥æœŸ
    created_at: datetime
```

### bot_tradesï¼ˆäº¤æ˜“è®°å½•ï¼‰

```python
class BotTrade(Base):
    __tablename__ = "bot_trades"
    id: int (PK)
    stock_code: str (indexed)
    stock_name: str
    action: str                   # buy|sell|reduce|hold
    quantity: int                 # äº¤æ˜“æ•°é‡ï¼ˆhold æ—¶ä¸º 0ï¼‰
    price: float                  # æˆäº¤ä»·æ ¼
    amount: float                 # äº¤æ˜“é‡‘é¢
    thinking: str (Text)          # è¯¦ç»†æ€è€ƒè¿‡ç¨‹
    report_id: int (FK â†’ ai_reports.id)
    trade_date: str               # äº¤æ˜“æ—¥æœŸ
    created_at: datetime
```

### bot_trade_reviewsï¼ˆå¤ç›˜è®°å½•ï¼‰

```python
class BotTradeReview(Base):
    __tablename__ = "bot_trade_reviews"
    id: int (PK)
    stock_code: str (indexed)
    stock_name: str
    total_buy_amount: float       # ç´¯è®¡ä¹°å…¥é‡‘é¢
    total_sell_amount: float      # ç´¯è®¡å–å‡ºé‡‘é¢
    pnl: float                    # ç›ˆäºé‡‘é¢
    pnl_pct: float                # ç›ˆäºç™¾åˆ†æ¯”
    first_buy_date: str
    last_sell_date: str
    holding_days: int             # æŒæœ‰å¤©æ•°
    review_thinking: str (Text)   # å®Œæ•´å¤ç›˜åˆ†æ
    memory_synced: bool           # æ˜¯å¦å·²åŒæ­¥è®°å¿†
    memory_note_id: str | None    # å…³è”çš„è®°å¿†ç¬”è®° ID
    trades: dict (JSON)           # è¯¥è‚¡ç¥¨æ‰€æœ‰äº¤æ˜“è®°å½•å¿«ç…§
    created_at: datetime
```

## äº¤æ˜“æ‰§è¡Œæµç¨‹

```
POST /api/ai/reports/save
  â†“ ä¿å­˜æˆåŠŸï¼Œè¿”å› report_id
  â†“
execute_bot_trades(report_id, report_date)
  â†“
éå† recommendations:
  â”œâ”€â”€ action=buy:
  â”‚   è®¡ç®— quantity = floor(100000 / target_price)
  â”‚   è®°å½• bot_trades(action=buy, quantity, price=target_price, amount)
  â”‚   æ›´æ–° bot_portfolio: æ–°å¢æˆ–åŠ ä»“ï¼ˆæ›´æ–° avg_costï¼‰
  â”‚
  â”œâ”€â”€ action=sell:
  â”‚   æŸ¥è¯¢ bot_portfolio æŒä»“
  â”‚   è®°å½• bot_trades(action=sell, quantity=å…¨éƒ¨, price=target_price)
  â”‚   ä» bot_portfolio åˆ é™¤è¯¥è‚¡ç¥¨
  â”‚   â†’ è§¦å‘å¤ç›˜
  â”‚
  â”œâ”€â”€ action=reduce:
  â”‚   è®¡ç®— sell_qty = floor(holding_qty * position_pct / 100)
  â”‚   è®°å½• bot_trades(action=reduce, quantity=sell_qty, price=target_price)
  â”‚   æ›´æ–° bot_portfolio(quantity -= sell_qty)
  â”‚   å¦‚æœ quantity == 0 â†’ è§¦å‘å¤ç›˜
  â”‚
  â””â”€â”€ action=hold:
      ä»…è®°å½• bot_trades(action=hold, quantity=0, price=å½“å‰ä»·)
      thinking è®°å½•æŒæœ‰ç†ç”±
```

## å¤ç›˜æµç¨‹

```
è‚¡ç¥¨æ¸…ä»“ï¼ˆquantity == 0ï¼‰
  â†“
start_review_job(stock_code, stock_name)
  â†“
ç‹¬ç«‹ Claude CLI è°ƒç”¨ï¼ˆfire-and-forgetï¼Œå¤ç”¨ claude-worker æ¨¡å¼ï¼‰:
  - è¾“å…¥: è¯¥è‚¡ç¥¨å…¨éƒ¨ bot_trades è®°å½•ï¼ˆæ—¥æœŸã€ä»·æ ¼ã€æ•°é‡ã€thinkingï¼‰
  - è¾“å…¥: é¦–æ¬¡ä¹°å…¥æ—¶çš„æŠ¥å‘Šæ‘˜è¦
  - è¾“å…¥: æœ€ç»ˆç›ˆäºæ•°æ®
  â†“
Claude è¾“å‡º JSON:
  {
    "review_thinking": "ä»æ–°é—»/æŠ€æœ¯/ç­–ç•¥ä¸‰ä¸ªç»´åº¦åˆ†æ...",
    "lessons_learned": "å…³é”®æ•™è®­...",
    "memory_note": {
      "id": "trade-review-XXXXXX-YYYYMMDD",
      "tags": ["trade-review", "stock-code", "profit|loss"],
      "content": "ä¸€æ®µè®°å¿†ç¬”è®°å†…å®¹"
    }
  }
  â†“
ä¿å­˜ bot_trade_reviews
  â†“
å†™å…¥è®°å¿†åº“:
  - åˆ›å»º episodic/trades/trade-review-{code}-{date}.md
  - æ›´æ–° meta/index.json
  - è¿è¡Œ python scripts/sync-memory.pyï¼ˆåŒæ­¥ Pineconeï¼‰
  â†“
æ›´æ–° memory_synced = true, memory_note_id
```

## åˆ†æå·¥ä½œæµå˜æ›´

ANALYSIS_SYSTEM_PROMPT çš„ Step 7 æ‰©å±•ï¼š

```
STEP 7: æ£€æŸ¥æŒä»“ â€” Check portfolio holdings
  - GET /api/stocks/portfolio â†’ ç”¨æˆ·çœŸå®æŒä»“ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
  - GET /api/bot/portfolio â†’ æœºå™¨äººæ¨¡æ‹ŸæŒä»“
  ä¸¤ä¸ªæŒä»“æ± éƒ½éœ€è¦è¯Šæ–­ï¼Œå–å‡º/å‡ä»“æ¨èè¦†ç›–ä¸¤è€…ã€‚
  åœ¨ recommendations ä¸­ç”¨ "source": "user"|"bot" åŒºåˆ†æ¥æºã€‚
```

## API ç«¯ç‚¹

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/bot/portfolio` | æœºå™¨äººå½“å‰æŒä»“ï¼ˆå«å½“å‰ä»·/ç›ˆäºï¼‰ |
| GET | `/api/bot/trades` | äº¤æ˜“è®°å½•åˆ—è¡¨ï¼ˆå¯æŒ‰ stock_code è¿‡æ»¤ï¼‰ |
| GET | `/api/bot/trades/{stock_code}` | æŸåªè‚¡ç¥¨çš„å®Œæ•´äº¤æ˜“æ—¶é—´çº¿ |
| GET | `/api/bot/reviews` | å¤ç›˜åˆ—è¡¨ |
| GET | `/api/bot/reviews/{id}` | å¤ç›˜è¯¦æƒ… |
| GET | `/api/bot/summary` | æ±‡æ€»ç»Ÿè®¡ï¼ˆæ€»æŠ•å…¥/å¸‚å€¼/ç›ˆäº/æŒä»“æ•°/å¤ç›˜æ•°ï¼‰ |

## å‰ç«¯è®¾è®¡

### AI é¡µé¢ Tab ç»“æ„

```
[å¸‚åœºåˆ†æ | AIäº¤æ˜“]
```

### AIäº¤æ˜“ Tab å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ±‡æ€»å¡ç‰‡                                              â”‚
â”‚  æ€»æŠ•å…¥ Â¥XXX,XXX | å½“å‰å¸‚å€¼ Â¥XXX,XXX                  â”‚
â”‚  æ€»ç›ˆäº Â¥Â±XX,XXX (Â±X.XX%) | æŒä»“ X åª | å¤ç›˜ X ç¯‡     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [å½“å‰æŒä»“ | å·²å®Œç»“]                                     â”‚
â”‚                                                       â”‚
â”‚ å½“å‰æŒä»“:                                              â”‚
â”‚ â”Œâ”€ åç»Ÿè‚¡ä»½ 002840 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ ä¹°å…¥: 2/24 Â¥9.65 Ã— 10,300è‚¡  æˆæœ¬ Â¥99,395     â”‚     â”‚
â”‚ â”‚ å½“å‰: Â¥9.80  ç›ˆäº +Â¥1,545 (+1.55%)            â”‚     â”‚
â”‚ â”‚ â–¼ äº¤æ˜“è®°å½• (2ç¬”)                               â”‚     â”‚
â”‚ â”‚  ğŸ“ˆ 2/24 ä¹°å…¥ 10,300è‚¡ @9.65                   â”‚     â”‚
â”‚ â”‚     "KDJé‡‘å‰ä¿¡å·è§¦å‘ï¼Œå†œç‰§æ¿å—å—æ˜¥èŠ‚æ¶ˆè´¹åˆ©å¥½..." â”‚     â”‚
â”‚ â”‚  â¸ 2/26 æŒæœ‰                                   â”‚     â”‚
â”‚ â”‚     "æŠ€æœ¯é¢ç»§ç»­å‘å¥½ï¼Œå»ºè®®æŒæœ‰ç­‰å¾…çªç ´..."        â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                       â”‚
â”‚ å·²å®Œç»“:                                                â”‚
â”‚ â”Œâ”€ å·¥ä¸šå¯Œè” 601138 â”€â”€ ç›ˆäº -Â¥3,200 (-3.2%) â”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ æŒæœ‰ 12å¤© | 3ç¬”äº¤æ˜“                             â”‚     â”‚
â”‚ â”‚ [å¤ç›˜] [è®°å¿†å·²åŒæ­¥ âœ“]                           â”‚     â”‚
â”‚ â”‚ â–¼ äº¤æ˜“è®°å½•                                      â”‚     â”‚
â”‚ â”‚  ğŸ“ˆ 2/12 ä¹°å…¥ 1,700è‚¡ @58.80                   â”‚     â”‚
â”‚ â”‚  ğŸ“‰ 2/18 å‡ä»“ 850è‚¡ @55.50                     â”‚     â”‚
â”‚ â”‚  ğŸ“‰ 2/24 æ¸…ä»“ 850è‚¡ @56.20                     â”‚     â”‚
â”‚ â”‚ â–¼ å¤ç›˜åˆ†æ                                      â”‚     â”‚
â”‚ â”‚  "è¯¥äº¤æ˜“çš„ä¸»è¦æ•™è®­æ˜¯ï¼šåœ¨éœ‡è¡å¸‚ä¸­è¿½é«˜ä¹°å…¥..."      â”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ‡ç­¾ç³»ç»Ÿ

| æ ‡ç­¾ | é¢œè‰² | å«ä¹‰ |
|------|------|------|
| æŒä»“ä¸­ | è“è‰² | å½“å‰ä»æŒæœ‰ |
| å·²æ¸…ä»“ | ç°è‰² | å…¨éƒ¨å–å‡º |
| ç›ˆåˆ© | ç»¿è‰² | æœ€ç»ˆç›ˆåˆ© |
| äºæŸ | çº¢è‰² | æœ€ç»ˆäºæŸ |
| å¤ç›˜å®Œæˆ | ç´«è‰² | å·²ç”Ÿæˆå¤ç›˜ |
| è®°å¿†å·²åŒæ­¥ | ç»¿è‰²å‹¾ | å·²å†™å…¥è®°å¿†åº“ |
| è®°å¿†æœªåŒæ­¥ | é»„è‰² | å¤ç›˜å®Œæˆä½†æœªåŒæ­¥ |

## å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | æ“ä½œ |
|------|------|
| `api/models/bot_trading.py` | æ–°å»º â€” BotPortfolio, BotTrade, BotTradeReview |
| `api/schemas/bot_trading.py` | æ–°å»º â€” è¯·æ±‚/å“åº” schema |
| `api/routers/bot_trading.py` | æ–°å»º â€” /api/bot/* ç«¯ç‚¹ |
| `api/services/bot_trading_engine.py` | æ–°å»º â€” execute_bot_trades(), äº¤æ˜“æ‰§è¡Œé€»è¾‘ |
| `api/routers/ai_analyst.py` | ä¿®æ”¹ â€” reports/save åè§¦å‘äº¤æ˜“æ‰§è¡Œ |
| `web/src/lib/claude-worker.ts` | ä¿®æ”¹ â€” ANALYSIS_SYSTEM_PROMPT åŠ å…¥ bot_portfolio, æ–°å¢å¤ç›˜ä»»åŠ¡ |
| `web/src/types/index.ts` | ä¿®æ”¹ â€” æ–°å¢ BotPortfolio/BotTrade/BotTradeReview ç±»å‹ |
| `web/src/lib/api.ts` | ä¿®æ”¹ â€” æ–°å¢ bot.* API |
| `web/src/hooks/use-queries.ts` | ä¿®æ”¹ â€” æ–°å¢ useBotPortfolio ç­‰ hooks |
| `web/src/app/ai/page.tsx` | ä¿®æ”¹ â€” å¢åŠ  AIäº¤æ˜“ Tab |
| `web/src/components/bot-trading/` | æ–°å»º â€” äº¤æ˜“é¢æ¿ç»„ä»¶ |
