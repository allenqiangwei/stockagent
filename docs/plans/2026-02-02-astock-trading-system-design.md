# A股量化交易系统设计文档

**日期**: 2026-02-02
**版本**: 1.0
**作者**: Allen Qiang

---

## 1. 系统目标

设计并开发一套基于A股市场的股票交易辅助系统，通过波段交易与趋势跟踪策略，实现以下目标：

- **年化收益率**: >100% (资金翻倍)
- **最大回撤**: <30%
- **使用场景**: 自用工具，辅助交易决策

---

## 2. 核心决策

在设计过程中做出的关键决策：

| 决策点 | 选择 | 理由 |
|--------|------|------|
| MVP策略 | 端到端完整流程 | 快速验证整体系统可行性 |
| 股票池规模 | 全市场3000+只 | 不错过任何机会，充分利用算力 |
| 信号生成时机 | 当晚19:00-22:00 | 充足决策时间，结合多源数据 |
| 新闻分析 | 简单规则法 | 快速实现，易于调试 |
| 数据存储 | Parquet + SQLite混合 | 性能与简单性平衡 |
| 回测深度 | 2-3年标准回测 | 覆盖多种市场环境 |
| 模型训练 | 初期手动，后期自动 | 充分理解模型后再自动化 |

---

## 3. 系统架构

### 3.1 整体架构

采用**模块化分层架构**，分为5个核心层：

```
┌─────────────────────────────────────────┐
│        应用层 (Application Layer)        │
│  ┌──────────┐  ┌──────────┐  ┌────────┐ │
│  │ Scheduler│  │Dashboard │  │  API   │ │
│  └──────────┘  └──────────┘  └────────┘ │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│        回测层 (Backtest Layer)          │
│  ┌──────────────┐  ┌─────────────────┐ │
│  │Backtest Engine│  │Performance Metrics│
│  └──────────────┘  └─────────────────┘ │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│         风控层 (Risk Layer)             │
│  ┌──────┐  ┌────────┐  ┌─────────────┐ │
│  │ Risk │  │Position│  │  Stop Loss  │ │
│  │Engine│  │Manager │  │             │ │
│  └──────┘  └────────┘  └─────────────┘ │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│       策略层 (Strategy Layer)           │
│  ┌──────────┐  ┌───────┐  ┌──────────┐ │
│  │Indicators│  │Signals│  │ML Models │ │
│  └──────────┘  └───────┘  └──────────┘ │
└─────────────────────────────────────────┘
                    │
┌─────────────────────────────────────────┐
│         数据层 (Data Layer)             │
│  ┌──────────┐  ┌───────┐  ┌──────────┐ │
│  │Collector │  │Storage│  │ Pipeline │ │
│  └──────────┘  └───────┘  └──────────┘ │
└─────────────────────────────────────────┘
```

### 3.2 模块职责

1. **数据层**: 多源数据采集、Parquet/SQLite存储、数据清洗管道
2. **策略层**: 技术指标计算、信号生成、XGBoost模型
3. **风控层**: 风险状态评估、仓位管理、止损机制
4. **回测层**: 历史数据回测、绩效分析
5. **应用层**: 定时调度、Web仪表盘、API接口

---

## 4. 数据层设计

### 4.1 数据采集

**多源策略**:
- **主数据源**: TuShare (付费)
- **备用源**: AkShare、Baostock
- **容灾**: 主源失败自动切换

**采集内容**:
- 日线K线数据 (3000+股票)
- 指数数据 (上证、深证、创业板)
- 资金流数据 (主力净流入)
- 基本面数据 (PE、PB、市值，每周更新)
- 财经新闻 (前20条标题)

**时间安排**:
- 15:30 开始拉取行情数据 (15-20分钟)
- 16:00 采集新闻 (3-5分钟)

### 4.2 数据存储

**混合存储方案**:

```
data/
├── market_data/               # Parquet文件
│   ├── daily/
│   │   ├── 2023.parquet      # 按年分区
│   │   ├── 2024.parquet
│   │   └── 2025.parquet
│   ├── index/
│   └── money_flow/
└── business.db               # SQLite数据库
    ├── signals               # 每日信号
    ├── positions             # 持仓记录
    ├── trades                # 交易记录
    ├── risk_status           # 风险状态历史
    └── backtest_results      # 回测结果
```

**优势**:
- Parquet: 高压缩比、快速读写、适合时序数据
- SQLite: 无需运维、适合业务数据、支持事务

### 4.3 数据更新

- **增量更新**: 检查最新日期，只拉取缺失数据
- **追加模式**: 新数据append到当年Parquet文件
- **年度归档**: 每年初归档上一年数据

---

## 5. 策略层设计

### 5.1 技术指标

实现以下核心指标:

| 类别 | 指标 | 用途 |
|------|------|------|
| 趋势 | MA、EMA、MACD、ADX | 判断趋势方向和强度 |
| 动量 | RSI、KDJ | 判断超买超卖 |
| 量价 | OBV、成交量MA | 验证价格走势 |

### 5.2 信号生成

**两大核心策略**:

#### 策略1: 波段交易
- **买入条件**:
  - 股价突破20日均线
  - MACD金叉
  - 成交量放大 (>5日均量1.5倍)
- **卖出条件**:
  - 股价跌破20日均线
  - MACD死叉
- **适用场景**: 震荡市、小幅上涨

#### 策略2: 趋势跟踪
- **买入条件**:
  - ADX > 25 (强趋势)
  - 价格站上60日均线
  - 资金净流入
- **卖出条件**:
  - ADX < 20 (趋势减弱)
  - 跌破60日均线
- **适用场景**: 单边牛市

### 5.3 XGBoost模型

**特征工程**:
- 技术指标: 20日涨幅、60日涨幅、RSI、MACD、ADX
- 量价特征: 5日换手率、量比、资金流入强度
- 基本面: PE百分位、PB百分位、市值

**训练策略**:
- **初期**: 手动训练，调整特征和参数
- **标签**: 未来5日收益率 > 3% 为正样本
- **后期**: 找到稳定配置后自动化

### 5.4 信号组合

**加权逻辑**:
- 波段信号: 40%
- 趋势信号: 40%
- XGBoost评分: 20%

**信号阈值**:
- 综合得分 > 60 → 买入
- 综合得分 < 40 → 卖出
- 40-60 → 持有

---

## 6. 风控层设计

### 6.1 风险状态评估

**三维度评分系统** (每维度0-100分):

#### 1. 新闻舆情评分
- 爬取财经网站前20条标题
- 负面关键词: ["暴跌", "跳水", "崩盘", "恐慌", "监管"] → -5分/条
- 正面关键词: ["大涨", "突破", "利好", "政策支持"] → +3分/条
- 基准分50分

#### 2. 指数趋势评分
- 上证指数 > 60日均线 → +30分
- 上证5日涨幅 > 2% → +20分
- 创业板相对强度 > 上证 → +20分
- ADX > 25 → +30分

#### 3. 资金流评分
- 北向资金净流入 > 50亿 → +40分
- 全市场主力净流入占比 > 60% → +30分
- 两融余额增长 → +30分

**状态判断**:
- 平均分 ≥ 70 → **Risk-on** (积极)
- 平均分 40-69 → **Neutral** (中性)
- 平均分 < 40 → **Risk-off** (防御)

### 6.2 仓位管理

| 风险状态 | 总仓位 | 持仓数量 | 单股上限 | 备注 |
|---------|--------|---------|---------|------|
| Risk-on | 60% | 6-10只 | 25% | 按信号评分加权分配 |
| Neutral | 30-40% | 4-6只 | 25% | 只买最强信号(>80分) |
| Risk-off | 0% | - | - | 不开新仓，执行止损 |

### 6.3 止损机制

**双重止损**:

1. **固定止损**:
   - 买入后跌破 -5% → 强制卖出

2. **移动止损** (锁定利润):
   - 盈利 ≥ 10% → 止损线上移至成本价+5%
   - 盈利 ≥ 20% → 止损线上移至成本价+15%
   - 锁定70%已有利润

---

## 7. 回测层设计

### 7.1 回测范围

- **时间窗口**: 2-3年历史数据
- **数据源**: Parquet存储的全市场日线
- **频率**: 每周运行一次完整回测

### 7.2 回测流程

```
每日回测步骤:
T日收盘后:
  1. 计算所有技术指标
  2. 生成信号(波段+趋势+ML)
  3. 评估风险状态
  4. 应用仓位管理
  5. 生成T+1日交易计划

T+1日:
  1. 开盘价买入/卖出(含滑点)
  2. 检查止损条件
  3. 更新持仓和资金
  4. 记录交易
```

### 7.3 成交模拟

- **买入价**: T+1开盘价 × 1.005 (滑点0.5%)
- **卖出价**: T+1开盘价 × 0.995 (滑点0.5%)
- **涨跌停**: 不成交
- **手续费**: 成交额 × 0.0003 (万三)

### 7.4 绩效指标

**收益类**:
- 总收益率、年化收益率、月度收益率

**风险类**:
- 最大回撤、回撤持续时间、波动率

**风险调整收益**:
- 夏普比率、卡玛比率

**交易统计**:
- 胜率、盈亏比、平均持仓天数、年化换手率

**分段分析**:
- 牛市/熊市/震荡市表现

---

## 8. 应用层设计

### 8.1 定时调度

**每日自动化流程**:

| 时间 | 任务 | 耗时 |
|------|------|------|
| 15:30 | 数据采集(行情、指数、资金流) | 15-20分钟 |
| 16:00 | 新闻采集+情绪分析 | 3-5分钟 |
| 19:00 | 信号生成+仓位分配 | 30-60分钟 |
| 20:00 | 回测(每周一次) | 2-3小时 |
| 22:00 | 数据备份 | 5分钟 |

### 8.2 Web仪表盘

**基于Streamlit开发**，包含以下页面:

#### 1. 首页 - 今日信号
- 次日交易计划(买入/卖出列表)
- 信号评分、建议操作、建议仓位
- 当前风险状态(Risk-on/Neutral/Risk-off)
- 市场情绪评分(新闻、指数、资金流)

#### 2. 持仓管理
- 当前持仓(成本、现价、盈亏%)
- 止损线显示(固定/移动)
- 总仓位占比、可用资金
- 历史交易记录

#### 3. 回测结果
- 权益曲线图
- 回撤曲线图
- 核心指标卡片(年化收益、最大回撤、夏普比率、胜率)
- 月度收益热力图
- 交易明细(可导出)

#### 4. 风险监控
- 风险状态历史趋势
- 新闻情绪词云
- 市场指标仪表盘

#### 5. 系统设置
- 参数配置
- 手动触发任务
- 用户管理

### 8.3 权限管理

- **管理员**: 修改设置、手动触发任务
- **只读用户**: 仅查看数据

---

## 9. 项目结构

```
stockagent/
├── config/                      # 配置文件
│   ├── config.yaml             # 主配置(API密钥、参数)
│   ├── news_keywords.json      # 新闻关键词库
│   └── stock_pool.txt          # 股票池(可选)
│
├── data/                       # 数据目录
│   ├── market_data/            # Parquet历史数据
│   ├── business.db             # SQLite业务数据
│   └── backups/                # 备份目录
│
├── src/                        # 源代码
│   ├── data_collector/         # 数据采集
│   ├── data_storage/           # 数据存储
│   ├── indicators/             # 技术指标
│   ├── signals/                # 信号生成
│   ├── ml_models/              # ML模型
│   ├── risk_engine/            # 风控引擎
│   ├── backtest_engine/        # 回测引擎
│   ├── scheduler/              # 定时调度
│   └── utils/                  # 工具函数
│
├── dashboard/                  # Streamlit仪表盘
│   ├── app.py
│   ├── pages/
│   └── components/
│
├── tests/                      # 单元测试
├── notebooks/                  # Jupyter笔记本(研究)
├── logs/                       # 日志目录
├── docs/                       # 文档目录
│   └── plans/                  # 设计文档
├── requirements.txt            # Python依赖
├── README.md                   # 项目说明
└── run.sh                      # 启动脚本
```

---

## 10. 技术栈

### 核心依赖

```yaml
数据处理:
  - pandas: 数据分析核心库
  - polars: 高性能数据处理(可选)
  - pyarrow: Parquet文件读写

数据源:
  - tushare: 主数据源
  - akshare: 备用数据源
  - baostock: 备用数据源
  - requests: HTTP请求
  - BeautifulSoup4: 新闻爬虫

技术分析:
  - ta-lib: 技术指标库(或pandas-ta)

机器学习:
  - xgboost: 梯度提升模型
  - scikit-learn: 特征工程、模型评估

数据库:
  - sqlite3: SQLite操作

任务调度:
  - APScheduler: 定时任务框架

Web界面:
  - streamlit: 仪表盘框架
  - plotly: 交互式图表
  - streamlit-authenticator: 权限管理

工具:
  - pyyaml: 配置文件解析
  - loguru: 日志管理
  - pytest: 单元测试
```

---

## 11. 开发路线图

### 阶段1: 数据基础 (2-3周)

**目标**: 建立可靠的数据获取和存储能力

- [ ] 实现TuShare数据采集器
- [ ] 实现AkShare、Baostock备用采集器
- [ ] 建立Parquet存储结构
- [ ] 设计SQLite数据库schema
- [ ] 实现增量数据更新pipeline
- [ ] 数据完整性验证
- [ ] 新闻爬虫实现

**交付物**:
- 稳定运行的数据采集系统
- 至少3个月的历史数据

### 阶段2: 信号引擎 (3-4周)

**目标**: 开发核心交易信号生成能力

- [ ] 实现技术指标计算模块
- [ ] 开发波段交易信号
- [ ] 开发趋势跟踪信号
- [ ] 实现新闻情绪简单规则分析
- [ ] 建立信号组合和加权逻辑
- [ ] 单元测试覆盖
- [ ] 信号质量验证

**交付物**:
- 每日生成3000+股票的信号评分
- 信号统计报告

### 阶段3: 回测和风控 (3-4周)

**目标**: 验证策略有效性，建立风险管理体系

- [ ] 开发回测引擎核心
- [ ] 实现订单模拟器
- [ ] 实现组合跟踪器
- [ ] 开发绩效分析模块
- [ ] 实现风险状态评估系统
- [ ] 建立仓位管理系统
- [ ] 实现止损机制
- [ ] 用2-3年历史数据验证策略

**交付物**:
- 完整回测报告
- 策略绩效评估
- 风控参数调优

### 阶段4: 应用和优化 (2-3周)

**目标**: 集成所有模块，提供友好的用户界面

- [ ] 开发Streamlit仪表盘
- [ ] 实现所有页面(首页、持仓、回测、风险)
- [ ] 实现定时调度系统
- [ ] 权限管理
- [ ] 系统集成测试
- [ ] 性能优化(3000股票处理速度)
- [ ] 日志和监控
- [ ] 部署到Mac Studio
- [ ] 编写使用文档

**交付物**:
- 可投入使用的完整系统
- 使用手册

### 总计时间: 10-14周 (2.5-3.5个月)

---

## 12. 部署方案

### 12.1 运行环境

- **硬件**: Mac Studio
- **操作系统**: macOS
- **Python版本**: 3.9+
- **虚拟环境**: venv 或 conda

### 12.2 部署步骤

```bash
# 1. 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 2. 安装依赖
pip install -r requirements.txt

# 3. 配置API密钥
cp config/config.yaml.example config/config.yaml
# 编辑config.yaml，填入TuShare token

# 4. 初始化数据库
python src/data_storage/init_db.py

# 5. 初始数据采集
python src/data_collector/initial_download.py

# 6. 启动调度器(后台运行)
nohup python src/scheduler/task_scheduler.py &

# 7. 启动仪表盘
streamlit run dashboard/app.py --server.port 8501
```

### 12.3 开机自启动

使用macOS的launchd配置开机自启动:

```xml
<!-- ~/Library/LaunchAgents/com.stockagent.scheduler.plist -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.stockagent.scheduler</string>
    <key>ProgramArguments</key>
    <array>
        <string>/path/to/venv/bin/python</string>
        <string>/path/to/src/scheduler/task_scheduler.py</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
```

### 12.4 局域网访问

- **仪表盘地址**: http://192.168.x.x:8501
- 在路由器中设置Mac Studio静态IP
- 其他设备通过浏览器访问

### 12.5 备份策略

- **自动备份**: 每日22:00备份SQLite和当日Parquet
- **备份目标**: 外置硬盘或NAS
- **保留策略**: 最近30天全量备份，之前只保留每周备份

---

## 13. 风险与挑战

### 13.1 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 数据源不稳定 | 数据缺失影响信号质量 | 多源容灾，本地缓存 |
| 3000股票计算性能 | 信号生成超时 | Polars加速，并行计算 |
| 回测与实盘偏差 | 策略实盘表现差 | 保守的滑点和手续费假设 |

### 13.2 合规风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 新闻爬虫合规性 | 可能违反robots.txt | 遵守爬虫协议，限制频率 |
| API使用限制 | TuShare积分不足 | 购买足够额度 |

### 13.3 交易风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 策略失效 | 持续亏损 | 持续回测监控，止损 |
| 黑天鹅事件 | 单日巨大亏损 | Risk-off机制，仓位控制 |
| 过度自信 | 忽视风险信号 | 严格遵守系统建议 |

---

## 14. 成功指标

### 14.1 系统稳定性指标

- [ ] 数据采集成功率 > 99%
- [ ] 信号生成准时率 > 95%
- [ ] 系统可用性 > 99.5%

### 14.2 策略性能指标

**最低目标** (6个月内):
- 年化收益率 > 50%
- 最大回撤 < 20%
- 月度胜率 > 60%

**终极目标** (1年内):
- 年化收益率 > 100%
- 最大回撤 < 30%
- 夏普比率 > 2.0

### 14.3 里程碑

- **1个月**: 完成数据基础+信号引擎，能生成每日信号
- **2个月**: 完成回测，验证策略有效性
- **3个月**: 系统上线，开始模拟盘测试
- **6个月**: 评估策略表现，决定是否实盘

---

## 15. 后续优化方向

待系统稳定运行后，可考虑以下增强:

1. **策略增强**
   - 加入更多策略类型(套利、事件驱动)
   - 优化XGBoost特征工程
   - 尝试深度学习模型(LSTM)

2. **数据增强**
   - 接入Level-2行情数据
   - 增加舆情数据源(社交媒体)
   - 财报数据深度分析

3. **系统增强**
   - 实现分钟级信号(日内交易)
   - 移动端App
   - 微信/邮件告警

4. **自动化增强**
   - 模型自动重训练
   - 策略自动优化(遗传算法)
   - 自动止盈/止损

---

## 16. 总结

本设计文档详细规划了一套**端到端的A股量化交易系统**，核心特点:

✅ **全面性**: 覆盖数据、策略、风控、回测、应用全链路
✅ **实用性**: 基于自用场景，注重稳定性和易用性
✅ **可行性**: 技术栈成熟，10-14周可完成MVP
✅ **可扩展**: 模块化设计，便于后续增强

系统通过**波段+趋势双策略**、**XGBoost模型加权**、**三维度风险评估**，力求在控制回撤的前提下实现高收益。

接下来建议按照4阶段开发路线，稳步推进实施。
